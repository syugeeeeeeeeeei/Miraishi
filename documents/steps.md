# 🚀 アプリケーション「未来視」開発手順書 (Electron-Vite版)

この手順書は、`youken.md` の要件と、`package.json` に記載された技術スタックを基に、Electronのアーキテクチャに最適化された開発プロセスを定義します。

---

### フェーズ 0: 基盤の整備と設定

**目的:** 既存のプロジェクトをベースに、データ永続化とプロセス間通信の土台を整える。

| ステップ                             | 内容                                                                                                                                                                                                                                                       | 実施するテスト                                                                                                       |
| :----------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------- |
| **Step 0-1: 型定義とバリデーション** | 1. 以前作成したTypeScriptの型定義 (`Scenario`, `Allowance`等)を `src/types/miraishi.d.ts` に配置。<br>2. `youken.md`の要件通り `Zod` を使い、これらの型に対応するバリデーションスキーマを `src/lib/validators` に作成する。                                | **【ユニットテスト (Vitest)】**<br>・Zodスキーマが、正しいデータ構造を許可し、不正なデータを拒否することを確認する。 |
| **Step 0-2: データ永続化の準備**     | 1. Mainプロセス (`src/main/index.ts`) で `electron-store` を初期化する。これにより、シナリオデータがローカルのJSONファイルに保存されるようになる。<br>2. 税制スキーマ (`tax_schema.json`) をプロジェクト内に配置し、Mainプロセスから読み込めるようにする。 | ・Mainプロセス起動時に`electron-store`のファイルが指定場所に作成されることを確認。                                   |

---

### フェーズ 1: Mainプロセス (バックエンドロジック) の実装

**目的:** ファイルI/O、データ処理、給与計算といったコアなロジックを、UIから完全に分離されたMainプロセス側で実装し、その正しさを保証する。

| ステップ                                | 内容                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 実施するテスト                                                                                                                                     |
| :-------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Step 1-1: 給与計算エンジンの実装**    | `src/main/lib/calculator.ts` のようなファイルに、`Scenario` オブジェクトと税制スキーマを引数として受け取り、給与予測結果を返す**純粋な関数**を実装する。この関数はElectronのAPIに一切依存しない。                                                                                                                                                                                                                                                                         | **【ユニットテスト (Vitest)】**<br>・様々な入力パターン（手当の有無、成長率、控除など）に対する計算結果が正しいことを網羅的にテストする。          |
| **Step 1-2: プロセス間通信(IPC)の定義** | `src/main/index.ts` に `ipcMain.handle` を使用して、Rendererプロセスからの要求を処理するAPIを定義する。<br>・`'scenarios:getAll'`: 全シナリオを取得<br>・`'scenarios:create'`: 新規シナリオを保存<br>・`'scenarios:update'`: 既存シナリオを更新<br>・`'scenarios:delete'`: シナリオを削除                                                                                                                                                                                 | -                                                                                                                                                  |
| **Step 1-3: データ整合性の確保**        | `electron-store` はファイルベースのKVSであり、RDBのようなトランザクションは無い。そのため、**データの整合性を保つために以下の作戦を徹底する。**<br>1. 更新処理は必ず「**Read -> Modify -> Write**」のパターンで行う。<br>2. `store.get('scenarios')`で全データを一度に取得。<br>3. メモリ上で配列操作（追加・更新・削除）を行う。<br>4. `store.set('scenarios', modifiedData)` で**全データを一度に書き戻す**。<br>この方法で、中途半端なデータが書き込まれる状態を防ぐ。 | **【統合テスト (Vitest)】**<br>・`ipcMain` の各ハンドラを呼び出し、`electron-store` のモックを使ってデータが期待通りに読み書きされるかテストする。 |
| **Step 1-4: Preloadスクリプトの実装**   | `src/preload/index.ts` を編集し、Mainプロセスで定義したIPCを安全にRendererプロセスへ公開するAPI (`window.api`) を定義する。<br>合わせて `src/preload/preload.d.ts` の型定義も更新する。                                                                                                                                                                                                                                                                                   | ・Preloadスクリプトが正しくAPIを公開できているかを確認（E2Eテストでカバー）。                                                                      |

---

### フェーズ 2: Rendererプロセス (UIと状態管理) の実装

**目的:** Mainプロセスが提供するAPIを利用して、`youken.md` に沿ったUIとユーザー体験を構築する。

| ステップ                               | 内容                                                                                                                                                                                                                                                                                        | 実施するテスト                                                                                                                                                                                   |
| :------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Step 2-1: グローバル状態管理の実装** | `youken.md`の要件通り `Jotai` を使用する。<br>`src/renderer/src/store/atoms.ts` にAtomを定義。<br>・`scenariosAtom`: `window.api` 経由で取得したシナリオ一覧を保持<br>・`uiStateAtom`: コントロールパネルの開閉状態などUIの状態を管理                                                       | **【ユニットテスト (Vitest)】**<br>・Atomの初期値や、更新ロジック（Reducer）が正しく動作することを確認。                                                                                         |
| **Step 2-2: UIコンポーネントの実装**   | `youken.md`の要件通り `Chakra UI` を活用し、再利用可能なUIコンポーネントを `src/renderer/src/components` に作成する。<br>・`DataView`, `GraphView`, `ControlPanel` などの大きなコンポーネントから、`StyledInput`, `AddButton` などの小さな部品まで実装。                                    | **【コンポーネントテスト (Vitest + Testing Library)】**<br>・各コンポーネントがpropsに応じて正しく表示されるか。<br>・ボタンクリック等のユーザー操作に対し、コールバック関数が正しく呼ばれるか。 |
| **Step 2-3: ビューの組み立てと連携**   | `src/renderer/src/App.tsx` を中心に、作成したコンポーネントとJotaiのAtomを組み合わせてアプリケーションの全体像を構築する。<br>・ユーザー操作をトリガーに `window.api` の関数を呼び出し、Mainプロセスにデータ処理を依頼する。<br>・処理結果はJotaiのAtomに反映させ、UIを再レンダリングする。 | -                                                                                                                                                                                                |

---

### フェーズ 3: 最終統合とテスト

**目的:** アプリケーション全体が一体として正しく動作することを保証する。

| ステップ                             | 内容                                                                                                                                                                                                                                            | 実施するテスト                                                                |
| :----------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------- |
| **Step 3-1: E2Eテスト**              | `Vitest` のElectron向けインテグレーションテスト機能や、必要であれば `Playwright` for Electron を使い、ユーザーの操作フローをシミュレートする。<br>・アプリを起動し、新規シナリオを作成→入力→保存→グラフ表示、という一連の流れを自動テストする。 | **【E2Eテスト】**<br>・主要なユーザーシナリオがエラーなく完了することを確認。 |
| **Step 3-2: ビルドとパッケージング** | `yarn build:win` や `yarn build:mac` コマンドが正常に完了し、各OS向けのインストーラーが作成されることを確認する。                                                                                                                               | ・ビルドされたアプリケーションが各OSで正常に起動し、動作することを確認。      |
